# 統合問題解決計画書 - PharmaDx Phase 2 問題対応

**作成日**: 2025年6月29日 15:50  
**作成者**: CEO  
**ステータス**: 緊急対応必要  
**優先度**: 最高  

## 1. エグゼクティブサマリー

本計画書は、私（CEO）の発見と独立監査レポートの指摘事項を統合し、PharmaDx Phase 2再構築で発生した重大問題への包括的な対応計画を定めるものである。

### 重大問題の統合リスト

#### 🔴 最優先（セキュリティ・即時対応）
1. **GitHub Pages公開ディレクトリ内のバックアップ** - 648KB×2の内部文書が公開状態
2. **CLAUDE.md更新履歴の虚偽記載** - 18:30移動完了と記載も実際は未実施

#### 🟡 高優先（機能不全・24時間以内）
3. **薬剤ページ生成不足** - 20薬剤中6薬剤のみ生成（30%）
4. **リンクパス完全不整合** - 全薬剤リンクが404エラー
5. **日本語ファイル名問題** - URL共有・SEOに深刻な影響

#### 🟢 中優先（構造問題・1週間以内）
6. **新旧構造の混在** - data/とgenerated/の重複と役割不明
7. **index.html重複** - どちらが正式版か不明
8. **変換ロジック設計欠陥** - C級薬効群から薬剤ページ生成不可

## 2. 問題詳細分析

### 2.1 セキュリティリスク分析

#### 現状
```
docs/
├── backup_20250629_153356/  # 648KB - 全世界公開状態
├── backup_20250629_153534/  # 648KB - 全世界公開状態
```

#### リスク
- **公開URL**: https://penwitmi.github.io/pharm_dex/backup_20250629_153356/
- **内容**: 開発ログ、内部文書、技術メモ
- **影響**: 機密情報の意図しない公開

### 2.2 機能不全分析

#### 薬剤ページ生成状況
```
期待: 20薬剤すべてのページ生成
実際: 6薬剤のみ（カンデサルタン、テルミサルタン、エソメプラゾール、
      ランソプラゾール、セルトラリン、エスシタロプラム）

原因:
- A級薬効群（ARB、PPI、SSRI）からのみ生成
- B級は部分的、C級は完全無視
- 個別薬剤生成ロジックの欠如
```

#### リンクパス問題
```
index.html記載: href="data/drugs/candesartan.html"  # 英語・旧パス
実際の生成:    generated/drugs/カンデサルタン.html  # 日本語・新パス
```

### 2.3 構造的混乱

#### ディレクトリ状況
```
docs/
├── data/drugs/        # 旧Phase 1の残骸（13ファイル、英語名）
├── generated/drugs/   # Phase 2生成（6ファイル、日本語名）
├── index.html        # 旧バージョン
└── generated/index.html # 新バージョン
```

## 3. 統合解決プラン

### Phase 0: 緊急対応（即時実行）

#### 0-1. セキュリティリスク除去
```bash
# バックアップの安全な場所への移動
mkdir -p project-docs/archive/backups/
mv docs/backup_* project-docs/archive/backups/

# Git履歴からも削除（必要に応じて）
git rm -r docs/backup_*
```

#### 0-2. CLAUDE.md更新履歴の修正
- 虚偽記載の訂正
- 実際の対応時刻の記録
- 教訓の追加

### Phase 1: 基本機能復旧（24時間以内）

#### 1-1. 薬剤ページ完全生成
**新アプローチ**: 薬効群依存ではなく、個別薬剤ベースの生成

```javascript
// convert_pharmadx.js に追加
async generateAllDrugPages() {
    for (const drugName of config.phase1Drugs) {
        const drugInfo = config.drugInfo[drugName];
        await this.generateSingleDrugPage(drugName, drugInfo);
    }
}
```

#### 1-2. ファイル名の英語化
```javascript
// config.json の修正
"drugNameMapping": {
    "カンデサルタン": "candesartan",
    "テルミサルタン": "telmisartan",
    // ... 全20薬剤
}
```

#### 1-3. リンクパスの統一
- すべてのリンクを `generated/drugs/[英語名].html` に統一
- index.htmlの全面的な更新

### Phase 2: 構造整理（1週間以内）

#### 2-1. ディレクトリ構造の明確化
```
docs/
├── index.html         # メインエントリー（1つのみ）
├── drugs/             # 個別薬剤ページ（英語名）
├── groups/            # 薬効群ページ
├── stories/           # ストーリーページ
├── css/               # スタイルシート
├── js/                # JavaScript
└── data/              # JSONデータのみ（HTMLは置かない）
```

#### 2-2. 旧構造の完全削除
- docs/data/drugs/ の削除
- docs/generated/ の内容を docs/ 直下に移動
- 重複ファイルの整理

### Phase 3: 品質保証（1ヶ月以内）

#### 3-1. 自動検証システム
```bash
# tools/validate.sh の作成
#!/bin/bash
# 1. バックアップがdocs/内にないことを確認
# 2. すべての薬剤ページが生成されていることを確認
# 3. リンク整合性チェック
# 4. ファイル名規則の確認
```

#### 3-2. ビルドプロセスの改善
- バックアップの自動的なproject-docs/移動
- 生成前の構造検証
- 生成後の品質チェック

## 4. 実行スケジュール

### 即時（今から30分以内）
- [ ] docs/backup_* の移動
- [ ] CLAUDE.md更新履歴の修正
- [ ] 本計画書のコミット

### 本日中（6月29日中）
- [ ] 薬剤ページ生成ロジックの修正
- [ ] 全20薬剤のページ生成
- [ ] index.htmlのリンク修正

### 明日中（6月30日中）
- [ ] ファイル名の英語化
- [ ] ディレクトリ構造の整理
- [ ] 検証スクリプトの作成

### 今週中（7月5日まで）
- [ ] 完全な動作検証
- [ ] ドキュメント更新
- [ ] Phase 3への移行準備

## 5. 成功基準

### 必須達成項目
1. ✅ docs/内にバックアップが存在しない
2. ✅ 20薬剤すべてのページが表示可能
3. ✅ すべてのリンクが正常動作
4. ✅ ファイル名はすべて英語
5. ✅ index.htmlは1つのみ

### 品質指標
- ページ読み込みエラー: 0
- 404エラー: 0
- 日本語URL: 0
- 重複ファイル: 0

## 6. リスクと対策

### リスク1: 作業中のサイト停止
**対策**: 新しいブランチで作業し、完了後にマージ

### リスク2: データ損失
**対策**: すべての変更前に完全バックアップ（project-docs/内）

### リスク3: 新たな不整合の発生
**対策**: 段階的実行と各段階での検証

## 7. 教訓と今後の予防策

### 学んだ教訓
1. **急いでも基本を守る** - バックアップは必須、配置場所も重要
2. **日本語ファイル名は避ける** - Web公開では英語名が安全
3. **新旧混在は危険** - 完全移行か共存設計かを明確に
4. **記録は正確に** - 虚偽の更新履歴は信頼を損なう

### 予防策
1. **ビルド前チェックリスト** の作成
2. **自動検証の必須化**
3. **セキュリティチェックの定期実行**
4. **更新履歴の自動生成** 検討

## 8. 結論

Phase 2再構築は野心的な試みであったが、実装において重大な問題が発生した。特にセキュリティリスクは即座に対処する必要がある。

本計画に従い、段階的かつ確実に問題を解決することで、PharmaDxを本来あるべき姿に修正する。

---

**承認**: _________________ （日付: ___________）

**実行開始**: 2025年6月29日 15:53