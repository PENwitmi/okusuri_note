# CLAUDE.md - PharmaDx プロジェクト

**最終更新**: 2025-06-29  
**現在フェーズ**: Phase 2完了、運用開始  
**公開サイト**: https://penwitmi.github.io/pharm_dex

## 🌟 プロジェクト概要

**PharmaDx - 薬剤図鑑** は、薬学生から臨床医まで対応する包括的な薬学教育Webプラットフォームです。「なぜ似た薬が複数存在するのか」への明確な回答を通じて、感動的なストーリーと詳細な薬学情報を統合し、真の薬学的理解を促進します。

### 🏗️ アーキテクチャ設計：コンテンツ分離型

```
content/          ←→          docs/
(コンテンツ原稿)    ｜変換｜    (公開サイト)
専門知識の蓄積      tools/     ユーザー体験
```

**設計原則**: 関心の分離 (Separation of Concerns)
- **content/**: 薬学知識の蓄積・編集（Markdown/HTML）
- **tools/**: 自動変換・ビルドプロセス（Node.js）
- **docs/**: 公開最適化サイト（GitHub Pages）

## 📊 現在の実装状況（2025-06-29）

### ✅ 完成コンテンツ
- **コンテンツファイル**: 48ファイル
  - ストーリー: 20ファイル
  - 薬効群モデル: 23ファイル  
  - 学習ツール: 5ファイル
- **生成Webサイト**: 30 HTMLファイル（324KB）
- **個別薬剤ページ**: 6薬剤実装済み
  - カンデサルタン、テルミサルタン（ARB）
  - エソメプラゾール、ランソプラゾール（PPI）
  - セルトラリン、エスシタロプラム（SSRI）

### 📁 ディレクトリ構造（Phase 2再構築済み）

```
pharma_dex/
├── content/                        # コンテンツ原稿（論理構造）
│   ├── stories/                    # 感動ストーリー（20ファイル）
│   ├── drug_database/              # 薬効群詳細モデル（23ファイル）
│   │   ├── cardiovascular/         # 循環器系
│   │   ├── gastrointestinal/       # 消化器系
│   │   ├── psychotropic/           # 精神科系
│   │   └── ...
│   ├── differentiation/            # 使い分けガイド
│   ├── study_tools/                # 学習ツール（5ファイル）
│   ├── exhibition/                 # 展示企画
│   └── resources/                  # リソース・データ
├── tools/                          # 開発ツール統合
│   ├── convert_pharmadx.js         # 変換エンジン
│   ├── config.json                 # 設定管理
│   ├── run_conversion.sh           # 変換実行
│   └── build.sh                    # 統合ビルド
├── docs/                           # 公開サイト（GitHub Pages）
│   ├── index.html                  # メインページ
│   ├── generated/                  # 変換済みコンテンツ（30ファイル）
│   │   ├── drugs/                  # 個別薬剤ページ（6ファイル）
│   │   ├── groups/                 # 薬効群ページ
│   │   ├── stories/                # ストーリーページ
│   │   └── ...
│   └── css/                        # メインスタイル
└── project-docs/                   # プロジェクト管理文書
    ├── architecture/               # アーキテクチャ設計書
    ├── development_guides/         # 開発ガイド
    └── project_management/         # プロジェクト管理
```

## 🔄 標準開発ワークフロー

### 1. コンテンツ編集フェーズ
```bash
# コンテンツ原稿編集
content/stories/              # ストーリー追加・修正
content/drug_database/        # 薬効群モデル追加・修正
content/study_tools/          # 学習ツール追加・修正
```

### 2. ビルド実行フェーズ
```bash
cd tools
./build.sh                    # 統合ビルド実行
```

### 3. 確認・デプロイフェーズ
```bash
cd ../docs
python -m http.server 8000    # ローカル確認
# GitHub Pages自動デプロイ
```

## 🎯 核心価値とコンテンツ戦略

### 教育理念
**「薬学知識の網目が真の理解を生む」**

### 5つのコンテンツタイプ
1. **薬効群進化モデル**: なぜ似た薬が複数存在するのかへの回答
2. **個別薬剤詳細**: 臨床使い分けの具体的基準
3. **感動ストーリー**: 薬剤開発の歴史的文脈と人間ドラマ
4. **学習ツール**: 国試対策・暗記支援
5. **実践ガイド**: 薬局実習・臨床応用

### クロスリファレンス型学習
- **学習の深化**: リンクが理解を深める
- **文脈の拡張**: 新たな視点を提供  
- **実用的価値**: 比較・選択に役立つ

## 🛠️ 技術スタック

### フロントエンド
- **HTML5/CSS3**: レスポンシブデザイン
- **Vanilla JavaScript**: インタラクティブ機能
- **GitHub Pages**: 静的サイトホスティング

### バックエンド（変換処理）
- **Node.js**: 変換エンジン
- **marked.js**: Markdown → HTML変換
- **Bash**: ビルドスクリプト

### 品質管理
- **コンテンツ品質**: A/B/C級分類システム
- **技術品質**: レスポンシブ、アクセシビリティ、SEO
- **統合品質**: 自動ビルド・検証プロセス

## 🚨 重要なルール

### Git Worktree不使用方針（2025-06-28確定）
**このプロジェクトではGit Worktreeを使用しません。**
- シンプルなWebサイト作成が目標のため、並列開発は不要
- 全ての開発は統一ディレクトリで実施
- 1つのエージェント/開発者での集中開発を推奨
- **Manager注意**: Worktree自動作成機能は使用禁止

### 作業場所の厳守
- すべての作業は `/Users/nishimototakashi/claude code/ai-team/code/pharma_dex/` 内で実施
- AI-Team外での作業は厳禁
- **異なる場所での作業は「虚偽報告」の主原因**

### アーキテクチャ原則の遵守
- **関心の分離**: content/ ↔ tools/ ↔ docs/
- **自動化**: 手動のHTML編集禁止、必ずtools/経由
- **一元管理**: 設定はtools/config.jsonに集約

### docs/ディレクトリの性質（重要）
**🚨 docs/は公開コンテンツ専用ディレクトリ**
- **GitHub Pages自動公開**: docs/内のすべてのファイルがhttps://penwitmi.github.io/pharm_dexで公開される
- **公開対象のみ配置**: HTML、CSS、JavaScript、画像、データファイルのみ
- **内部文書は厳禁**: 開発ログ、バックアップファイル、TODO、設計書、会議メモなどは絶対に配置禁止
- **機密情報の漏洩リスク**: うっかり内部文書を配置すると全世界に公開される

**✅ docs/に配置すべきもの**
- index.html（メインページ）
- generated/（変換済み公開コンテンツ）
- css/（スタイルシート）
- js/（JavaScript）
- data/（公開用データファイル）

**❌ docs/に配置してはいけないもの**
- dev_logs/（開発ログ）→ project-docs/archive/development-logs/
- *.backup（バックアップファイル）→ project-docs/archive/
- server.log（ログファイル）→ project-docs/archive/development-logs/
- TODO.md、MEMO.md等の内部文書 → project-docs/
- 個人情報、APIキー、設定ファイル等の機密情報

### CEO×Manager協働体制（2025-06-27強化）
**単なるメッセージ転送ではなく、深い思考による価値創造を**

#### なぜ協働思考が必要か
1. **表面的な指示では教育的価値が生まれない**
   - ❌「薬の使い分けを書いて」→ 添付文書の羅列
   - ✅「なぜこの薬が必要になったか」→ 本質的理解

2. **PharmaDxの核心価値を実現するため**
   - 「なぜ似た薬が複数存在するのか」への深い回答
   - 感動的なストーリーと実用的知識の最適な融合
   - 学生から臨床医まで各レベルでの価値創造

#### 協働判断基準（4つのトリガー）
協働が必要な場面を見極める具体的基準：

1. **影響度（Impact）**: プロジェクト全体の方向性に関わる
2. **複雑さ（Complexity）**: 複数専門知識の統合が必要
3. **前例性（Precedent）**: 今後の標準となる重要な決定
4. **リスク（Risk）**: 失敗時の影響が重大

**判断基準**: 3つ以上が「高」→必須協働、2つが「高」→推奨協働

## 📈 現在のフェーズと今後の計画

### ✅ Phase 2完了（2025-06-29）
- 大規模ディレクトリ構造改造完了
- コンテンツ分離アーキテクチャ確立
- 統合ビルドプロセス確立
- 30 HTMLファイル生成・公開

### 🔄 Phase 3準備中
- **最新薬剤特集**: FIC薬剤（First-in-Class）の追加
  - エサキセレノン（MRA進化）
  - サクビトリルバルサルタン（ARNi革命）
  - SGLT2阻害薬、GLP-1受容体作動薬等
- **コンテンツ拡張**: 300薬剤への拡張計画
- **高度機能**: AI検索、パーソナライズ学習

### 📋 長期ビジョン
- **自動化パイプライン**: GitHub Actions導入
- **品質管理**: 自動テスト・検証システム
- **スケーラビリティ**: 大量コンテンツ対応
- **ユーザー機能**: パーソナライズ・学習進捗管理

## 🎓 教育的インパクト

### 従来の限界を突破
- **暗記中心 → 理解中心**: なぜそうなるかの本質的理解
- **単発学習 → 体系学習**: 薬学知識の相互関連性
- **理論偏重 → 実践統合**: 臨床現場での実用価値

### 学習体験の革新
- **感動 → 興味 → 深化**: 自然な学習動機の創出
- **視覚化 → 記憶定着**: 進化図・比較表による理解促進
- **クロスリファレンス → 応用力**: 多角的思考能力の育成

## 📚 関連ドキュメント

### アーキテクチャ
- `project-docs/architecture/CONTENT_SEPARATION_ARCHITECTURE.md` - 分離アーキテクチャ設計書
- `project-docs/guides/PHASE2_DEVELOPMENT_WORKFLOW.md` - 開発ワークフロー
- `project-docs/planning/PHASE2_MAJOR_RESTRUCTURE_PLAN.md` - Phase 2計画書

### 参照・分析
- `project-docs/reference/content-index/DRUG_CONTENT_INDEX.md` - 全コンテンツインデックス
- `project-docs/reference/analysis-reports/` - 分析レポート類

### 開発ガイド
- `README.md` - プロジェクト概要・クイックスタート
- `tools/` - ビルドツール・変換スクリプト
- `content/` - コンテンツ編集ガイド（各ディレクトリのREADME参照）
- `project-docs/README.md` - ドキュメント構造ガイド

## 🚨 重要な教訓・学習記録

### CLAUDE.md誤上書きインシデント（2025-06-23追加）
- **原因**: 既存ファイルが空という異常状態を正常と誤認
- **教訓**: 既存ファイルが空 = 絶対におかしい。特にCLAUDE.mdは必ず内容がある
- **対策**: 既存ファイルは必ずReadで確認、Writeツール使用禁止、Editのみ使用
- **根本原因**: 「既存のものには既存の内容がある」という当たり前の前提の欠如

### Firebase無料枠超過インシデント（2025-06-22追加）
- **原因**: onSnapshot内でデータ変更→無限ループ
- **教訓**: リスナー内でのデータ変更は絶対禁止
- **対策**: ローカルエミュレータ優先、使用量の定期確認
- **詳細**: 各プロジェクトの`docs/development-guides/FIREBASE_BEST_PRACTICES.md`参照

### Readツールのoffset誤用インシデント（2025-06-23追加）
- **原因**: offset=450を指定したが、ファイルは324行しかなかった
- **症状**: 「Warning: the file exists but the contents are empty」と誤表示
- **教訓**: offsetは行番号を意味する。範囲外を指定すると空と判定される
- **対策**: 
  1. 事前に`wc -l`でファイル行数を確認
  2. 不確実な場合はoffsetを使わずに全体を読む
  3. 大きなファイルでも、まず先頭を読んでから必要に応じてoffsetを使用

### ディレクトリ違反事例（2025-06-26追記）
- `/Users/nishimototakashi/claude code/futuristic-pharmacy/` のような場所での作業は厳禁
- ブレインストーミング文書は必ず `/docs/` 内に作成
- コード実装は必ず `/code/` 内に作成
- **なぜ重要か**: 異なる場所での作業は、成果物の発見を困難にする。「虚偽報告」の多くは、実は作業場所の相違が原因。開発者は誠実に作業していても、場所が違えば見つからない。

### Git管理体制の混乱事例（2025-06-29追加）
- **問題**: 開発者によるGit操作実行
- **対策**: CEO以外のGit操作完全禁止
- **フロー**: 開発者→Manager品質確認→CEO承認→Git実行
- **重要性**: 未検品コードのコミットは品質保証の根幹を破る

### CLAUDE.md無バックアップ全面改訂インシデント（2025-06-29発生）
- **原因**: ドキュメント整合性確保を急ぐあまり、バックアップ作成を怠った
- **問題**: 蓄積された重要な技術的メモ・教訓・注意事項を一時的に消失
- **被害**: 
  - 重要な教訓・学習記録の一時消失
  - 技術的注意事項の一時消失
  - CEO×Manager協働体制詳細の一時消失
  - 復元作業による時間損失
- **教訓**: **どんなに急いでいてもバックアップは絶対必須**
- **対策**: 
  1. 重要ファイル編集前は必ずバックアップ作成
  2. 大規模変更は段階的実行（Read→バックアップ→部分Edit→検証→次段階）
  3. 全面書き換えは原則禁止、Editによる段階的更新を優先
  4. 「急ぐ」は「バックアップしない」理由にならない
- **根本原因**: 基本的な安全手順の軽視、「便利だから」という理由でのWriteツール使用

## 📋 技術的注意事項

### ファイル操作
1. **CLAUDE.mdは必ず内容がある（30KB以上が正常）**
2. **空のCLAUDE.md = 異常事態として即座に停止**
3. **更新はEditのみ、Writeツール使用厳禁**
4. **ファイルサイズ管理**: 上限20KB（推奨15KB以下）
5. **バックアップ必須**: 重要ファイル編集前は必ずバックアップ作成
   - 命名規則: `filename_backup_YYYYMMDD_HHMM.extension`
   - 場所: `_old_files/backup_YYYYMMDD_HHMM/`
   - **例外なし**: 「急ぐ」「簡単」「小さな変更」は理由にならない
6. **段階的更新原則**: 大規模変更は Read→バックアップ→部分Edit→検証のサイクル

### ビルドプロセス
1. **Node.jsエラー**: `cd tools && rm -rf node_modules && npm install`
2. **パス参照エラー**: 新構造のパス確認（content/, docs/, tools/）
3. **変換失敗**: tools/ディレクトリから実行確認、権限確認

### バックアップ必須
- 編集前に`_old_files/backup_YYYYMMDD_HHMM/`へコピー
- 重要変更時は新規バックアップフォルダ作成
- tools/build.shは自動バックアップ機能付き

## 🎓 開発知見ドキュメント
- **場所**: `/Users/nishimototakashi/claude code/development-insights/`
- **内容**: 実プロジェクトから抽出した汎用的な知見・パターン集
  - Firebaseベストプラクティス（無限ループ対策等）
  - パフォーマンス最適化の判断基準
  - 状態管理パターン（2画面分離、カスタムフック）
  - ドメイン特化UI/UXデザイン
  - アンチパターン集
  - 再利用可能なコードテンプレート
- **活用**: 新規プロジェクト開始時に参照、実装時のテンプレートとして利用

## 更新履歴

- **2025-06-29 18:30**: docs/ディレクトリの誤用修正（重要）
  - **問題発見**: docs/dev_logs/, docs/*.backup, docs/server.log等が公開ディレクトリに配置
  - **重大リスク**: GitHub Pages経由で内部文書が全世界に公開される危険性
  - **対策実行**: 内部文書をproject-docs/archive/development-logs/に移動
  - **予防策**: CLAUDE.md・README.mdにdocs/の性質と配置禁止事項を明記
  - **教訓**: docs/は公開コンテンツ専用、内部文書は絶対配置禁止
- **2025-06-29 18:00**: project-docsディレクトリ大規模整理完了
  - **問題**: 深いネスト構造（project_management/planning/）とルート散乱ファイル
  - **解決**: 論理的・フラット化構造への再編（6つのカテゴリ分類）
  - **改善**: reference/, architecture/, guides/, planning/, progress/, archive/
  - **効果**: ドキュメント発見性向上、相対パス問題解決、バックアップディレクトリ整理
- **2025-06-29 16:00**: CLAUDE.md無バックアップ全面改訂インシデント発生・復元完了
  - **16:30**: バックアップなしでの全面改訂実行（重大ミス）
  - **17:00**: 重要情報消失発覚、復元作業開始
  - **17:30**: 重要な教訓・技術的注意事項・協働体制詳細の復元完了
  - **教訓**: バックアップは絶対必須、「急ぐ」は理由にならない
- **2025-06-29**: アーキテクチャ設計書作成 - コンテンツ分離型設計の明文化
- **2025-06-29**: Phase 2大規模再構築完了 - 論理的ディレクトリ構造・統合ビルドプロセス確立
- **2025-06-28**: Git Worktree不使用方針確定
- **2025-06-23**: CLAUDE.md誤上書きインシデントの教訓追加、絶対的前提ルール追加
- **2025-06-22**: Firebase無料枠超過の教訓を追加

---

**PharmaDx** - 薬学教育の未来を創造する包括的プラットフォーム